# pnpm vs Turbo - 役割と導入タイミング

## 誤解しやすいポイント

pnpmとTurboは**どちらか選ぶものではなく、役割が異なります**。

```
pnpm    = パッケージマネージャー（必須）
Turbo   = ビルド最適化ツール（オプション）
```

両方併用することで、最高のパフォーマンスを得られます。

## それぞれの役割

### pnpm（必須）

**何をするツール？**

- 依存関係のインストール
- パッケージの管理
- モノレポのワークスペース管理

**なぜpnpm？（npm/yarnではなく）**

- ディスク容量の節約（シンボリックリンク方式）
- インストールが速い
- 厳密な依存関係管理（幽霊依存を防ぐ）
- モノレポサポートが優秀
- 業界標準になりつつある（Next.js、Vue、Svelte等が採用）

**基本的な使い方:**

```bash
# インストール
pnpm install

# パッケージ追加
pnpm add react

# ワークスペース全体でコマンド実行
pnpm -r build  # 全パッケージでbuildを実行
pnpm -r test   # 全パッケージでtestを実行

# 特定のパッケージでコマンド実行
pnpm --filter @sample/ui build
```

### Turbo（オプション）

**何をするツール？**

- タスク（build, test等）の並列実行
- タスク結果のキャッシュ
- 差分ビルド（変更されたパッケージのみ）
- タスク間の依存関係管理

**なぜTurbo？**

- ビルド時間を大幅に短縮（10分→1分など）
- CI/CDの高速化
- ローカル開発の快適さ向上

**基本的な使い方:**

```bash
# 通常のpnpm
pnpm -r build  # 全パッケージを毎回ビルド（遅い）

# Turbo使用
pnpm turbo build  # キャッシュがあればスキップ（速い）
                  # 並列実行で高速化
                  # 依存順序を自動解決
```

## 段階的な導入戦略

### フェーズ1: pnpmのみ（推奨スタート）

**構成:**

```
pnpm workspace
└── Changesets
```

**メリット:**

- シンプル
- 学習コストが低い
- 小規模プロジェクトには十分

**ビルドコマンド:**

```json
// package.json
{
  "scripts": {
    "build": "pnpm -r --workspace-concurrency=1 run build",
    "test": "pnpm -r run test",
    "lint": "pnpm -r run lint"
  }
}
```

`--workspace-concurrency=1`で依存順序を考慮した逐次ビルド。

### フェーズ2: Turbo追加（ビルドが遅くなったら）

**構成:**

```
pnpm workspace
├── Changesets
└── Turbo
```

**導入のタイミング:**

- ビルドに1分以上かかる
- パッケージが10個以上
- CI/CDのビルド時間が気になる

**セットアップ:**

```bash
pnpm add -D -w turbo
```

`turbo.json`:

```json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**"]
    },
    "test": {
      "dependsOn": ["build"],
      "outputs": ["coverage/**"]
    },
    "lint": {
      "outputs": []
    },
    "dev": {
      "cache": false
    }
  }
}
```

**ビルドコマンド:**

```json
// package.json
{
  "scripts": {
    "build": "turbo build",
    "test": "turbo test",
    "lint": "turbo lint",
    "dev": "turbo dev"
  }
}
```

## パフォーマンス比較

### 実際のビルド時間の例

**プロジェクト構成:**

- 5パッケージ
- 各パッケージのビルド時間: 10秒

#### pnpmのみ（逐次実行）

```bash
pnpm -r run build
# util: 10秒
# ui: 10秒（utilに依存）
# nextjs: 10秒（uiに依存）
# demo: 10秒（nextjsに依存）
合計: 40秒
```

#### Turbo（初回ビルド）

```bash
pnpm turbo build
# util: 10秒
# ui, nextjs, demoを並列実行（依存関係を考慮）
合計: 20-25秒（並列化により高速化）
```

#### Turbo（2回目以降、変更なし）

```bash
pnpm turbo build
# すべてキャッシュヒット
合計: 1秒以下
```

#### Turbo（utilのみ変更）

```bash
pnpm turbo build
# util: 10秒（変更あり、再ビルド）
# ui: 10秒（utilの変更の影響）
# nextjs: キャッシュヒット
# demo: キャッシュヒット
合計: 15秒
```

## コスト・ベネフィット分析

### pnpmのみの場合

**導入コスト:** ⭐☆☆☆☆（非常に低い）

- インストール: 1分
- 設定: 5分（pnpm-workspace.yaml作成）

**メリット:** ⭐⭐⭐☆☆

- 基本的な機能は十分
- シンプルで理解しやすい
- メンテナンス不要

**デメリット:**

- ビルドが遅い（全パッケージ毎回ビルド）
- CI/CDで時間がかかる

### Turbo追加の場合

**導入コスト:** ⭐⭐☆☆☆（低い）

- インストール: 1分
- 設定: 15-30分（turbo.json作成、調整）
- 学習: 1-2時間

**メリット:** ⭐⭐⭐⭐⭐

- ビルド時間が大幅に短縮
- キャッシュで2回目以降が超高速
- CI/CDコスト削減（GitHub Actionsの分数節約）
- 開発体験の向上

**デメリット:**

- 設定ファイルが1つ増える
- トラブルシューティングが少し複雑になる

## 推奨フロー

### このプロジェクトでの推奨

**初期段階（今）:**

```
✅ pnpm（必須）
✅ Changesets
❌ Turboは後回し
```

**理由:**

- パッケージが少ない（5個程度）
- まだコンポーネントが少ない
- ビルド時間は許容範囲内のはず
- シンプルさを優先

**Turbo導入を検討するタイミング:**

1. ビルドに1分以上かかるようになった
2. パッケージが10個以上に増えた
3. CI/CDの実行時間が気になってきた
4. 開発中に`pnpm build`を頻繁に実行する

**導入は簡単:**

```bash
# たった2ステップで導入可能
pnpm add -D -w turbo
# turbo.jsonを作成（15分程度）
```

いつでも追加できるので、まずはシンプルに始めましょう。

## 他のツールとの比較

### Nx vs Turbo

もしTurboを導入するなら、Nxも選択肢です。

| 項目               | Turbo                              | Nx                                   |
| ------------------ | ---------------------------------- | ------------------------------------ |
| **学習コスト**     | ⭐⭐☆☆☆ 低い                       | ⭐⭐⭐⭐☆ 高い                       |
| **機能**           | シンプル（キャッシュとタスク実行） | 多機能（ジェネレータ、プラグイン等） |
| **パフォーマンス** | 非常に速い                         | 速い                                 |
| **設定**           | 簡単（turbo.json 1ファイル）       | 複雑（多数の設定ファイル）           |
| **適用範囲**       | 既存プロジェクトに追加しやすい     | Nxありきの構成になりがち             |

**このプロジェクトでは:**

- シンプルさ優先 → **Turbo**
- 大規模で複雑な構成 → Nx

## まとめ

### 答え：「pnpmとTurbo、どちらが良い？」

**正確な答え:**

- **pnpm**: 必須（これがないと始まらない）
- **Turbo**: オプション（後から追加できる）

### 推奨される導入順序

```
1. pnpm ← 今すぐ導入
2. TypeScript, ESLint等の基本設定
3. Changesets ← リリース管理
4. パッケージ・コンポーネント開発
5. Turbo ← ビルドが遅くなったら導入
```

### 次のステップ

まずはpnpmとChangesetsで環境構築を始めましょう。
Turboは、実際にビルドが遅いと感じた時点で導入すれば十分です。

**今やること:**

1. pnpmのインストール確認
2. pnpm-workspace.yamlの作成
3. 各パッケージの基本構造作成
4. Changesetsのセットアップ
